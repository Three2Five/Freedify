<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Freedify</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/static/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/icon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css?v=2">
    <!-- Google API for Drive sync -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Keyboard Shortcuts Help -->
    <div id="shortcuts-help" class="shortcuts-help hidden">
        <div class="shortcuts-content">
            <div class="shortcuts-header">
                <h3>‚å®Ô∏è Keyboard Shortcuts</h3>
                <button id="shortcuts-close" class="shortcuts-close">√ó</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut"><kbd>Space</kbd><span>Play/Pause</span></div>
                <div class="shortcut"><kbd>‚Üí</kbd><span>Next Track</span></div>
                <div class="shortcut"><kbd>‚Üê</kbd><span>Previous Track</span></div>
                <div class="shortcut"><kbd>Shift + ‚Üí</kbd><span>Seek +10s</span></div>
                <div class="shortcut"><kbd>Shift + ‚Üê</kbd><span>Seek -10s</span></div>
                <div class="shortcut"><kbd>‚Üë</kbd><span>Volume Up</span></div>
                <div class="shortcut"><kbd>‚Üì</kbd><span>Volume Down</span></div>
                <div class="shortcut"><kbd>M</kbd><span>Mute/Unmute</span></div>
                <div class="shortcut"><kbd>S</kbd><span>Shuffle Queue</span></div>
                <div class="shortcut"><kbd>R</kbd><span>Toggle Repeat</span></div>
                <div class="shortcut"><kbd>F</kbd><span>Fullscreen</span></div>
                <div class="shortcut"><kbd>Q</kbd><span>Toggle Queue</span></div>
                <div class="shortcut"><kbd>?</kbd><span>This Help</span></div>
            </div>
        </div>
    </div>

    <div class="app">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">üéµ Freedify</h1>
            <div class="header-actions">
                <button id="hifi-btn" class="header-btn" title="HiFi Mode - Stream lossless FLAC (faster startup, more data)">HiFi</button>
                <label for="file-input" class="header-btn" title="Add Local Songs (MP3/FLAC)" style="cursor: pointer; display: inline-flex; align-items: center; justify-content: center;">üìÇ</label>
                <button id="dj-mode-btn" class="header-btn" title="DJ Mode">üéß</button>
                <button id="sync-btn" class="header-btn" title="Sync with Google Drive">‚òÅÔ∏è</button>
                <button id="theme-btn" class="theme-btn" title="Change Theme">üé®</button>
            </div>
        </header>
        
        <!-- Theme Picker Dropdown -->
        <div id="theme-picker" class="theme-picker hidden">
            <div class="theme-option" data-theme="">üåô Default</div>
            <div class="theme-option" data-theme="theme-purple">üíú Purple</div>
            <div class="theme-option" data-theme="theme-blue">üíô Blue</div>
            <div class="theme-option" data-theme="theme-green">üíö Green</div>
            <div class="theme-option" data-theme="theme-pink">üíï Pink</div>
            <div class="theme-option" data-theme="theme-orange">üß° Orange</div>
        </div>

        <!-- Search Section -->
        <section class="search-section">
            <div class="search-container">
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input"
                    placeholder="Search music or paste ANY link (Spotify, Bandcamp, SoundCloud...)"
                    autocomplete="off"
                    title="Search or Import"
                >
                <button id="search-clear" class="search-clear" title="Clear search">√ó</button>
            </div>
            
            <!-- Search Type Selector -->
            <div class="search-type-selector">
                <button class="type-btn active" data-type="track">Songs</button>
                <button class="type-btn" data-type="album">Albums</button>
                <button class="type-btn" data-type="artist">Artists</button>
                <button class="type-btn" data-type="podcast">Podcasts</button>
                <button id="search-more-btn" class="type-btn more-btn">‚ãÆ More</button>
            </div>
            
            <!-- Search More Menu -->
            <div id="search-more-menu" class="search-more-menu hidden">
                <button class="menu-item type-btn-menu" data-type="ytmusic">YT Music</button>
                <button class="menu-item type-btn-menu" data-type="setlist">Setlists</button>
                <button class="menu-item type-btn-menu" data-type="rec">For You</button>
                <button class="menu-item type-btn-menu" data-type="favorites">Playlists</button>
            </div>
        </section>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="loading-content">
                <div class="spinner"></div>
                <p id="loading-text">Loading...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="error-message hidden">
            <span class="error-icon">üòï</span>
            <p id="error-text">Something went wrong</p>
            <button id="error-retry" class="btn-retry">Try Again</button>
        </div>

        <!-- Download Modal -->
        <div id="download-modal" class="modal hidden">
            <div class="modal-content">
                <h3>Download Track</h3>
                <p id="download-track-name">Track Name</p>
                
                <div class="format-selector">
                    <label>Select Format:</label>
                    <select id="download-format">
                        <option value="mp3">MP3 (320kbps)</option>
                        <option value="flac">FLAC (Lossless)</option>
                        <option value="aiff">AIFF (DJ Friendly)</option>
                        <option value="wav">WAV (Lossless)</option>
                        <option value="alac">ALAC (Apple Lossless)</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button id="download-cancel-btn" class="btn-secondary">Cancel</button>
                    <button id="download-drive-btn" class="btn-secondary" title="Save to Google Drive">‚òÅÔ∏è Save to Drive</button>
                    <button id="download-confirm-btn" class="btn-primary">Download</button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <section id="results-section" class="results-section">
            <div id="results-container" class="results-container">
                <!-- Search results will be inserted here -->
                <div class="empty-state">
                    <span class="empty-icon">üîç</span>
                    <p>Search for your favorite music</p>
                    <p class="hint">Or paste a Spotify link to an album or playlist</p>
                </div>
            </div>
            <button id="load-more-btn" class="load-more-btn hidden">Load More Results</button>
        </section>

        <!-- Album/Playlist Detail View -->
        <section id="detail-view" class="detail-view hidden">
            <div class="detail-header">
                <button id="back-btn" class="back-btn">‚Üê Back</button>
                <div class="detail-actions">
                    <button id="shuffle-btn" class="shuffle-btn" title="Shuffle & Play">Shuffle</button>
                    <button id="queue-all-btn" class="queue-all-btn">Add All to Queue</button>
                    <button id="download-all-btn" class="download-all-btn">Download ZIP</button>
                </div>
            </div>
            <div id="detail-info" class="detail-info">
                <!-- Album/playlist info will be inserted here -->
            </div>
            <div id="detail-tracks" class="detail-tracks">
                <!-- Tracks will be inserted here -->
            </div>
        </section>

        <!-- Queue Section -->
        <section id="queue-section" class="queue-section hidden">
            <div class="queue-header">
                <h3>Queue <span id="queue-count">(0)</span></h3>
                <div class="queue-controls">
                    <button id="queue-clear" class="queue-clear">Clear</button>
                    <button id="queue-close" class="queue-close-btn" title="Close Queue">√ó</button>
                </div>
            </div>
            <div id="queue-container" class="queue-container">
                <!-- Queue items will be inserted here -->
            </div>
        </section>

        <!-- Bottom Player -->
        <div id="player-bar" class="player-bar hidden">
            <!-- Main visible row (Art + Info + Primary Controls) -->
            <div class="player-main-row">
                <div class="player-info">
                    <img id="player-art" class="player-art" src="" alt="Album art">
                    <div class="player-details">
                        <p id="player-title" class="player-title">No track playing</p>
                        <div class="player-meta-row">
                            <span id="player-artist" class="player-artist clickable" title="Search artist">-</span>
                            <span class="player-separator">‚Ä¢</span>
                            <span id="player-album" class="player-album clickable" title="View album">-</span>
                            <span id="player-year" class="player-year"></span>
                            <span id="audio-format-badge" class="audio-format-badge hidden">MP3</span>
                        </div>
                    </div>
                </div>
                
                <div class="player-controls-primary">
                    <button id="prev-btn" class="control-btn" title="Previous">‚èÆ</button>
                    <button id="play-btn" class="control-btn play-btn" title="Play/Pause">‚ñ∂</button>
                    <button id="next-btn" class="control-btn" title="Next">‚è≠</button>
                    <button id="fs-toggle-btn" class="control-btn" title="Full Screen">‚§¢</button>
                    <button id="mini-player-btn" class="control-btn" title="Popout Winamp Player" style="font-size: 1.2rem;">‚ßâ</button>
                    <button id="more-controls-btn" class="control-btn" title="More Options">‚ãÆ</button>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="player-progress">
                <span id="current-time" class="time">0:00</span>
                <input type="range" id="progress-bar" class="progress-bar" min="0" max="100" value="0" title="Seek">
                <span id="duration" class="time">0:00</span>
            </div>
            
            <!-- More Menu (Popup) -->
            <div id="player-more-menu" class="player-more-menu hidden">
                <div class="more-menu-grid">
                    <button id="shuffle-queue-btn" class="control-btn" title="Shuffle Queue">‚§≠</button>
                    <button id="repeat-btn" class="control-btn" title="Repeat: Off">‚ü≥</button>
                    <button id="download-current-btn" class="control-btn" title="Download">‚¨á</button>
                    <button id="queue-btn" class="control-btn queue-toggle" title="Queue">‚ò∞</button>
                    <button id="mute-btn" class="control-btn volume-btn" title="Mute">üîä</button>
                    <button id="eq-toggle-btn" class="control-btn eq-btn" title="Equalizer">üéõÔ∏è</button>
                    <button id="ai-radio-btn" class="control-btn ai-radio-btn" title="AI Radio">üìª</button>
                    <button id="add-to-playlist-btn" class="control-btn" title="Add to Playlist">ü©∑</button>
                </div>
                <!-- Volume slider inside menu for mobile compactness -->
                <div class="more-menu-volume">
                     <input type="range" id="volume-slider" class="volume-slider" min="0" max="100" value="100" title="Volume">
                </div>
            </div>
        </div>

        <!-- Equalizer Panel -->
        <div id="eq-panel" class="eq-panel hidden">
            <div class="eq-header">
                <h3>üéõÔ∏è Equalizer</h3>
                <button id="eq-close-btn" class="eq-close-btn">√ó</button>
            </div>
            
            <div class="eq-presets">
                <button class="eq-preset active" data-preset="flat">Flat</button>
                <button class="eq-preset" data-preset="bass">Bass Boost</button>
                <button class="eq-preset" data-preset="treble">Treble</button>
                <button class="eq-preset" data-preset="vocal">Vocal</button>
            </div>
            
            <div class="eq-sliders">
                <div class="eq-band">
                    <input type="range" id="eq-60" class="eq-slider" min="-12" max="12" value="0" orient="vertical">
                    <span class="eq-label">60Hz</span>
                </div>
                <div class="eq-band">
                    <input type="range" id="eq-230" class="eq-slider" min="-12" max="12" value="0">
                    <span class="eq-label">230Hz</span>
                </div>
                <div class="eq-band">
                    <input type="range" id="eq-910" class="eq-slider" min="-12" max="12" value="0">
                    <span class="eq-label">910Hz</span>
                </div>
                <div class="eq-band">
                    <input type="range" id="eq-3600" class="eq-slider" min="-12" max="12" value="0">
                    <span class="eq-label">3.6kHz</span>
                </div>
                <div class="eq-band">
                    <input type="range" id="eq-7500" class="eq-slider" min="-12" max="12" value="0">
                    <span class="eq-label">7.5kHz</span>
                </div>
            </div>
            
            <div class="eq-extras">
                <div class="eq-extra">
                    <label for="bass-boost">Bass Boost</label>
                    <input type="range" id="bass-boost" class="eq-boost-slider" min="0" max="12" value="0">
                    <span id="bass-boost-val">0dB</span>
                </div>
                <div class="eq-extra">
                    <label for="volume-boost">Volume Boost</label>
                    <input type="range" id="volume-boost" class="eq-boost-slider" min="0" max="6" value="0">
                    <span id="volume-boost-val">0dB</span>
                </div>
            </div>
        </div>

        <!-- Audio Elements (dual for gapless/crossfade) -->
        <audio id="audio-player" preload="auto"></audio>
        <audio id="audio-player-2" preload="auto"></audio>
    </div>

    <!-- Fullscreen Player Overlay (outside .app for proper fixed positioning) -->
    <div id="fullscreen-player" class="fullscreen-player hidden">
        <div class="fs-backdrop"></div>
        <div class="fs-content">
            <div class="fs-header">
                 <button id="fs-close-btn" class="fs-close-btn">√ó</button>
            </div>
            <div class="fs-art-container">
                <img id="fs-art" src="/static/icon.svg" alt="Album Art">
            </div>
            <div class="fs-info">
                <h2 id="fs-title">No Track Playing</h2>
                <p id="fs-artist">Select music to play</p>
                <div id="fs-dj-info" class="fs-dj-info hidden"></div>
            </div>
            <div class="fs-progress-container">
                <span id="fs-current-time">0:00</span>
                <input type="range" id="fs-progress-bar" class="progress-bar" min="0" max="100" value="0" title="Seek">
                <span id="fs-duration">0:00</span>
            </div>
            <div class="fs-controls">
                <button id="fs-heart-btn" class="fs-control-btn" title="Add to Playlist">ü©∑</button>
                <button id="fs-prev-btn" class="fs-control-btn">‚èÆ</button>
                <button id="fs-play-btn" class="fs-control-btn play-btn">‚ñ∂</button>
                <button id="fs-next-btn" class="fs-control-btn">‚è≠</button>
                <button id="fs-download-btn" class="fs-control-btn" title="Download">‚¨á</button>
            </div>
        </div>
    </div>

    <!-- Podcast Episode Details Modal -->
    <div id="podcast-modal" class="podcast-modal hidden">
        <div class="podcast-modal-content">
            <button id="podcast-modal-close" class="podcast-modal-close">√ó</button>
            <img id="podcast-modal-art" class="podcast-modal-art" src="" alt="Episode Art">
            <h2 id="podcast-modal-title" class="podcast-modal-title"></h2>
            <p id="podcast-modal-date" class="podcast-modal-date"></p>
            <p id="podcast-modal-duration" class="podcast-modal-duration"></p>
            <div id="podcast-modal-description" class="podcast-modal-description"></div>
            <div class="podcast-modal-actions">
                <button id="podcast-modal-play" class="podcast-modal-play">‚ñ∂ Play Episode</button>
            </div>
        </div>
    </div>

    <!-- DJ Setlist Modal -->
    <div id="dj-setlist-modal" class="dj-modal hidden">
        <div class="dj-modal-content">
            <div class="dj-modal-header">
                <h2>üéß AI DJ Setlist</h2>
                <button id="dj-modal-close" class="dj-modal-close">√ó</button>
            </div>
            <div class="dj-modal-body">
                <div class="dj-style-selector">
                    <label>Set Style:</label>
                    <select id="dj-style-select">
                        <option value="progressive">Progressive (Build Energy)</option>
                        <option value="peak-time">Peak Time (High Energy)</option>
                        <option value="chill">Chill (Low-Med Energy)</option>
                        <option value="journey">Journey (Wave Pattern)</option>
                    </select>
                </div>
                <div id="dj-setlist-loading" class="dj-loading hidden">
                    <div class="spinner"></div>
                    <p>Analyzing tracks and generating setlist...</p>
                </div>
                <div id="dj-setlist-results" class="dj-results hidden">
                    <div id="dj-ordered-tracks" class="dj-ordered-tracks"></div>
                </div>
            </div>
            <div class="dj-modal-actions">
                <button id="dj-generate-btn" class="btn-primary">‚ú® Generate Setlist</button>
                <button id="dj-apply-btn" class="btn-secondary hidden">Apply to Queue</button>
            </div>
        </div>
    </div>

    <!-- Hidden File Input (Moved to body end for reliability) -->
    <input 
        type="file" 
        id="file-input" 
        multiple 
        accept="audio/*,.flac,.mp3,.wav,.aiff,.aac,.ogg,.m4a" 
        style="position: fixed; top: -100px; left: -100px; opacity: 0; pointer-events: none;" 
        onclick="this.value=null"
        onchange="if(window.handleFiles) { window.handleFiles(this.files); } else { alert('Error: handleFiles not loaded'); }"
    >

    <!-- Playlist Selection Modal -->
    <div id="playlist-modal" class="modal hidden">
        <div class="modal-content playlist-modal-content">
            <h3>Add to Playlist</h3>
            <div id="playlist-list" class="playlist-list"></div>
            <div class="create-playlist-row">
                <input type="text" id="new-playlist-input" placeholder="New playlist name..." class="new-playlist-input">
                <button id="create-playlist-btn" class="btn-primary">+</button>
            </div>
            <button id="playlist-modal-close" class="btn-secondary" style="width:100%; margin-top:12px;">Cancel</button>
        </div>
    </div>



    <!-- Setlist Detail Modal -->
    <div id="setlist-modal" class="modal hidden">
        <div class="modal-content setlist-modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Setlist</h3>
                <button id="setlist-close-btn" class="modal-close-btn">√ó</button>
            </div>
            
            <div id="setlist-info" class="setlist-header-info">
                <!-- Artist at Venue - Date inserted here -->
            </div>
            
            <div id="setlist-tracks" class="setlist-tracks-list">
                <!-- Tracks inserted here -->
            </div>
            
            <div class="modal-actions" style="margin-top: 16px;">
                <button id="setlist-play-btn" class="btn-primary" style="width: 100%;">
                    üéß Listen to Show
                </button>
            </div>
        </div>
    </div>

    <script src="static/jsmediatags.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="/static/app.js?v=0104C"></script>
</body>
</html>
